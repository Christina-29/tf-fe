pipeline {
    agent any
    parameters {
        // string(name: 'environment', defaultValue: 'terraform', description: 'Workspace/environment file to use for deployment')
        choice(name: 'workspace', choices:['uat', 'prod'], description: 'which Workspace')
        booleanParam(name: 'destroy', defaultValue: false, description: 'Destroy Terraform build?')
    }

    stages {
        stage('Terraform init') {
            steps {
                dir("applications/aws_frontend") {
                    sh 'terraform init'
                    sh 'terraform workspace list'
                    sh "terraform workspace select ${params.workspace}"          
                }    
            }
        }
        stage('Terraform apply') {
            when {
                not {
                    equals expected: true, actual: params.destroy
                }
            }
            steps {
                dir("applications/aws_frontend") {
                    sh 'terraform apply --auto-approve'
                    sh 'rm -rf terraform.tfvars'
                }
            }
        }
        stage('Terraform destory') {
            when {
              equals expected: true, actual: params.destroy
            }  
            steps{
              dir("applications/aws_frontend"){                
                sh 'terraform destroy --auto-approve'
                sh 'rm -rf terraform.tfvars'                
              }
           }
        }
    }
    post {
        always {
            cleanWs()
        }
    }
}
           